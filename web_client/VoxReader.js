var DEFAULT_PALETTE = [
    [0, 0, 0, 0],
    [255, 255, 255, 255],
    [255, 204, 255, 255],
    [255, 153, 255, 255],
    [255, 102, 255, 255],
    [255, 51, 255, 255],
    [255, 0, 255, 255],
    [255, 255, 204, 255],
    [255, 204, 204, 255],
    [255, 153, 204, 255],
    [255, 102, 204, 255],
    [255, 51, 204, 255],
    [255, 0, 204, 255],
    [255, 255, 153, 255],
    [255, 204, 153, 255],
    [255, 153, 153, 255],
    [255, 102, 153, 255],
    [255, 51, 153, 255],
    [255, 0, 153, 255],
    [255, 255, 102, 255],
    [255, 204, 102, 255],
    [255, 153, 102, 255],
    [255, 102, 102, 255],
    [255, 51, 102, 255],
    [255, 0, 102, 255],
    [255, 255, 51, 255],
    [255, 204, 51, 255],
    [255, 153, 51, 255],
    [255, 102, 51, 255],
    [255, 51, 51, 255],
    [255, 0, 51, 255],
    [255, 255, 0, 255],
    [255, 204, 0, 255],
    [255, 153, 0, 255],
    [255, 102, 0, 255],
    [255, 51, 0, 255],
    [255, 0, 0, 255],
    [255, 255, 255, 204],
    [255, 204, 255, 204],
    [255, 153, 255, 204],
    [255, 102, 255, 204],
    [255, 51, 255, 204],
    [255, 0, 255, 204],
    [255, 255, 204, 204],
    [255, 204, 204, 204],
    [255, 153, 204, 204],
    [255, 102, 204, 204],
    [255, 51, 204, 204],
    [255, 0, 204, 204],
    [255, 255, 153, 204],
    [255, 204, 153, 204],
    [255, 153, 153, 204],
    [255, 102, 153, 204],
    [255, 51, 153, 204],
    [255, 0, 153, 204],
    [255, 255, 102, 204],
    [255, 204, 102, 204],
    [255, 153, 102, 204],
    [255, 102, 102, 204],
    [255, 51, 102, 204],
    [255, 0, 102, 204],
    [255, 255, 51, 204],
    [255, 204, 51, 204],
    [255, 153, 51, 204],
    [255, 102, 51, 204],
    [255, 51, 51, 204],
    [255, 0, 51, 204],
    [255, 255, 0, 204],
    [255, 204, 0, 204],
    [255, 153, 0, 204],
    [255, 102, 0, 204],
    [255, 51, 0, 204],
    [255, 0, 0, 204],
    [255, 255, 255, 153],
    [255, 204, 255, 153],
    [255, 153, 255, 153],
    [255, 102, 255, 153],
    [255, 51, 255, 153],
    [255, 0, 255, 153],
    [255, 255, 204, 153],
    [255, 204, 204, 153],
    [255, 153, 204, 153],
    [255, 102, 204, 153],
    [255, 51, 204, 153],
    [255, 0, 204, 153],
    [255, 255, 153, 153],
    [255, 204, 153, 153],
    [255, 153, 153, 153],
    [255, 102, 153, 153],
    [255, 51, 153, 153],
    [255, 0, 153, 153],
    [255, 255, 102, 153],
    [255, 204, 102, 153],
    [255, 153, 102, 153],
    [255, 102, 102, 153],
    [255, 51, 102, 153],
    [255, 0, 102, 153],
    [255, 255, 51, 153],
    [255, 204, 51, 153],
    [255, 153, 51, 153],
    [255, 102, 51, 153],
    [255, 51, 51, 153],
    [255, 0, 51, 153],
    [255, 255, 0, 153],
    [255, 204, 0, 153],
    [255, 153, 0, 153],
    [255, 102, 0, 153],
    [255, 51, 0, 153],
    [255, 0, 0, 153],
    [255, 255, 255, 102],
    [255, 204, 255, 102],
    [255, 153, 255, 102],
    [255, 102, 255, 102],
    [255, 51, 255, 102],
    [255, 0, 255, 102],
    [255, 255, 204, 102],
    [255, 204, 204, 102],
    [255, 153, 204, 102],
    [255, 102, 204, 102],
    [255, 51, 204, 102],
    [255, 0, 204, 102],
    [255, 255, 153, 102],
    [255, 204, 153, 102],
    [255, 153, 153, 102],
    [255, 102, 153, 102],
    [255, 51, 153, 102],
    [255, 0, 153, 102],
    [255, 255, 102, 102],
    [255, 204, 102, 102],
    [255, 153, 102, 102],
    [255, 102, 102, 102],
    [255, 51, 102, 102],
    [255, 0, 102, 102],
    [255, 255, 51, 102],
    [255, 204, 51, 102],
    [255, 153, 51, 102],
    [255, 102, 51, 102],
    [255, 51, 51, 102],
    [255, 0, 51, 102],
    [255, 255, 0, 102],
    [255, 204, 0, 102],
    [255, 153, 0, 102],
    [255, 102, 0, 102],
    [255, 51, 0, 102],
    [255, 0, 0, 102],
    [255, 255, 255, 51],
    [255, 204, 255, 51],
    [255, 153, 255, 51],
    [255, 102, 255, 51],
    [255, 51, 255, 51],
    [255, 0, 255, 51],
    [255, 255, 204, 51],
    [255, 204, 204, 51],
    [255, 153, 204, 51],
    [255, 102, 204, 51],
    [255, 51, 204, 51],
    [255, 0, 204, 51],
    [255, 255, 153, 51],
    [255, 204, 153, 51],
    [255, 153, 153, 51],
    [255, 102, 153, 51],
    [255, 51, 153, 51],
    [255, 0, 153, 51],
    [255, 255, 102, 51],
    [255, 204, 102, 51],
    [255, 153, 102, 51],
    [255, 102, 102, 51],
    [255, 51, 102, 51],
    [255, 0, 102, 51],
    [255, 255, 51, 51],
    [255, 204, 51, 51],
    [255, 153, 51, 51],
    [255, 102, 51, 51],
    [255, 51, 51, 51],
    [255, 0, 51, 51],
    [255, 255, 0, 51],
    [255, 204, 0, 51],
    [255, 153, 0, 51],
    [255, 102, 0, 51],
    [255, 51, 0, 51],
    [255, 0, 0, 51],
    [255, 255, 255, 0],
    [255, 204, 255, 0],
    [255, 153, 255, 0],
    [255, 102, 255, 0],
    [255, 51, 255, 0],
    [255, 0, 255, 0],
    [255, 255, 204, 0],
    [255, 204, 204, 0],
    [255, 153, 204, 0],
    [255, 102, 204, 0],
    [255, 51, 204, 0],
    [255, 0, 204, 0],
    [255, 255, 153, 0],
    [255, 204, 153, 0],
    [255, 153, 153, 0],
    [255, 102, 153, 0],
    [255, 51, 153, 0],
    [255, 0, 153, 0],
    [255, 255, 102, 0],
    [255, 204, 102, 0],
    [255, 153, 102, 0],
    [255, 102, 102, 0],
    [255, 51, 102, 0],
    [255, 0, 102, 0],
    [255, 255, 51, 0],
    [255, 204, 51, 0],
    [255, 153, 51, 0],
    [255, 102, 51, 0],
    [255, 51, 51, 0],
    [255, 0, 51, 0],
    [255, 255, 0, 0],
    [255, 204, 0, 0],
    [255, 153, 0, 0],
    [255, 102, 0, 0],
    [255, 51, 0, 0],
    [255, 0, 0, 238],
    [255, 0, 0, 221],
    [255, 0, 0, 187],
    [255, 0, 0, 170],
    [255, 0, 0, 136],
    [255, 0, 0, 119],
    [255, 0, 0, 85],
    [255, 0, 0, 68],
    [255, 0, 0, 34],
    [255, 0, 0, 17],
    [255, 0, 238, 0],
    [255, 0, 221, 0],
    [255, 0, 187, 0],
    [255, 0, 170, 0],
    [255, 0, 136, 0],
    [255, 0, 119, 0],
    [255, 0, 85, 0],
    [255, 0, 68, 0],
    [255, 0, 34, 0],
    [255, 0, 17, 0],
    [255, 238, 0, 0],
    [255, 221, 0, 0],
    [255, 187, 0, 0],
    [255, 170, 0, 0],
    [255, 136, 0, 0],
    [255, 119, 0, 0],
    [255, 85, 0, 0],
    [255, 68, 0, 0],
    [255, 34, 0, 0],
    [255, 17, 0, 0],
    [255, 238, 238, 238],
    [255, 221, 221, 221],
    [255, 187, 187, 187],
    [255, 170, 170, 170],
    [255, 136, 136, 136],
    [255, 119, 119, 119],
    [255, 85, 85, 85],
    [255, 68, 68, 68],
    [255, 34, 34, 34],
    [255, 17, 17, 17]
];

export default class VoxReader {
    constructor (data) {
        this.data = data;
        this.chunkInfo = {};
        this.modelInfo = null;
    }

    isValid () {
        return String.fromCharCode.apply(String, this.data.slice(0, 4)) === 'VOX ';
    }

    read () {
        this._readChunk(8, this.chunkInfo);

        if ('MAIN' !== this.chunkInfo.header) {
            throw new Error('No MAIN section present in vox file');
        }
    }

    getModel () {
        // Lazy-load model info from the raw chunk data
        if (this.modelInfo) {
            return this.modelInfo;
        }
        this.modelInfo = {};

        _.each(this.chunkInfo.children, child => {
            if (child.header === 'SIZE') {
                this.modelInfo.size = {
                    x: new Uint32Array(child.content.buffer.slice(0, 4))[0],
                    y: new Uint32Array(child.content.buffer.slice(4, 8))[0],
                    z: new Int32Array(child.content.buffer.slice(8, 12))[0]
                }
            } else if (child.header === 'RGBA') {
                this.modelInfo.palette = [[0, 0, 0, 0]];
                for (var i = 0; i < child.content.length; i += 4) {
                    this.modelInfo.palette.push([
                        child.content[i],
                        child.content[i+1],
                        child.content[i+2],
                        child.content[i+3]
                    ]);
                }
            } else if (child.header === 'XYZI') {
                this.modelInfo.nVoxels = new Uint32Array(child.content.buffer.slice(0, 4))[0];
                this.modelInfo.voxels = child.content.slice(4);
            }

            // TODO material properties
        });
        if (!this.modelInfo.palette) {
            this.modelInfo.palette = DEFAULT_PALETTE;
        }

        return this.modelInfo;
    }

    _readChunk (addr, chunkInfo) {
        var n = new Uint32Array(this.data.buffer.slice(addr + 4, addr + 8))[0];
        var m = new Uint32Array(this.data.buffer.slice(addr + 8, addr + 12))[0];

        chunkInfo.addr = addr;
        chunkInfo.header = String.fromCharCode.apply(String, this.data.slice(addr, addr + 4));
        chunkInfo.content = this.data.slice(addr + 12, addr + 12 + n);
        chunkInfo.children = [];

        addr += 12 + n;
        while (addr < chunkInfo.addr + 12 + n + m) {
            var childInfo = {};
            addr = this._readChunk(addr, childInfo);
            chunkInfo.children.push(childInfo);
        }

        return addr;
    }
}
